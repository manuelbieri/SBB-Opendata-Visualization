let delayCutoff=3;function bubbleChart(){let width=940;let height=600;let center={x:width/2,y:height/2};let xCenters={0:{x:width/3},1:{x:2*width/3}};let yCenters={0:{y:height/3},1:{y:height/3*2}};const dates=new Set();let titleX={0:30,1:xCenters["0"].x,2:xCenters["1"].x};let titleY={0:20,1:yCenters["0"].y-30,2:yCenters["1"].y+30};let forceStrength=0.03;let svg=null;let bubbles=null;let nodes=[];function charge(d){return-Math.pow(d.radius,2.45)*forceStrength}let simulation=d3.forceSimulation().velocityDecay(0.2).force('x',d3.forceX().strength(forceStrength).x(center.x)).force('y',d3.forceY().strength(forceStrength).y(center.y)).force('charge',d3.forceManyBodyReuse().strength(charge)).on('tick',ticked);simulation.stop();let fillColorLine=d3.scaleOrdinal().domain(['IC6','IC61','IC1','IC8']).range(['red','orange','blue','green']);let fillColorRollingStock=d3.scaleOrdinal().domain(['IC2000','FVDosto','ICN','Eurocity']).range(['red','orange','blue','green']);function calcDelay(e){return e.ANKUNFTSZEIT-e.AN_PROGNOSE}function calcRadius(diff){if(diff> -delayCutoff*60*1000){return 3}else{return Math.log10(Math.abs(diff))}}function createNodes(rawData,dateRange){for(let i=0;i<rawData.length;i+=1){rawData[i].ANKUNFTSZEIT=new Date(rawData[i].ANKUNFTSZEIT);rawData[i].AN_PROGNOSE=new Date(rawData[i].AN_PROGNOSE);rawData[i].BETRIEBSTAG=new Date(rawData[i].BETRIEBSTAG);dates.add(rawData[i].BETRIEBSTAG.getDate()+"-"+(rawData[i].BETRIEBSTAG.getMonth()+1)+"-"+rawData[i].BETRIEBSTAG.getFullYear())}rawData=rawData.filter(d=>{let inFirstRange=dateRange.date1.getTime()<=d.ANKUNFTSZEIT.getTime()&&d.ANKUNFTSZEIT.getTime()<=dateRange.date2.getTime();if(dateRange.date3!=null&&dateRange.date4!=null){return inFirstRange||dateRange.date3.getTime()<=d.ANKUNFTSZEIT.getTime()&&d.ANKUNFTSZEIT.getTime()<=dateRange.date4.getTime()}else{return inFirstRange}});let datesArray=Array.from(dates);setUpDateRange("#firstDateRange",datesArray,0,1);setUpDateRange("#secondDateRange",datesArray,datesArray.length-2,datesArray.length-1);parseSliderDates();let myNodes=rawData.map(function(d){let diff=calcDelay(d);return{ANKUNFTSZEIT:d.ANKUNFTSZEIT,AN_PROGNOSE:d.AN_PROGNOSE,LINIEN_ID:d.LINIEN_ID,diff:diff,radius:calcRadius(diff),LINIEN_TEXT:d.LINIEN_TEXT,block:d.block,BETRIEBSTAG:d.BETRIEBSTAG,globalstrahlung:d.globalstrahlung,luftdruck:d.luftdruck,luftfeuchtigkeit:d.luftfeuchtigkeit,lufttemperatur:d.lufttemperatur,niederschlag:d.niederschlag,schnee:d.schnee,sonnenschein:d.sonnenschein,x:width/2+(Math.random()*40-20),y:height/2+(Math.random()*40-20)}});myNodes.sort(function(a,b){return b.diff-a.diff});return myNodes}let chart=function chart(selector,rawData,args){nodes=createNodes(rawData,args.dates);svg=d3.select(selector).append('svg').attr('width',width).attr('height',height);bubbles=svg.selectAll('.bubble').data(nodes,function(d){return d.LINIEN_ID});let bubblesE=bubbles.enter().append('circle').classed('bubble',true).attr('r',0).attr('fill',d=>{return getColor(d,isRollingStockColor())}).attr('stroke',d=>{return d3.rgb(getColor(d,isRollingStockColor())).darker()}).attr('stroke-width',2).on('click',showDetail).on('mouseover',(e,d)=>{console.log(e.currentTarget);console.log(this);console.log(d)});bubbles=bubbles.merge(bubblesE);bubbles.transition().duration(2000).attr('r',function(d){return d.radius});simulation.nodes(nodes);GroupBubbles()};function ticked(){bubbles.attr('cx',function(d){return d.x}).attr('cy',function(d){return d.y})}function nodeXPos(d,args){return xCenters[calcCategory(args.category1,args.cutoff1,d)].x}function nodeYPos(d,args){return yCenters[calcCategory(args.category2,args.cutoff2,d)].y}function calcCategory(criteria,cutoff,d){if(criteria==="Sonnenschein"){return compare(d.sonnenschein,cutoff)}else if(criteria==="Schnee"){return compare(d.schnee,cutoff)}else if(criteria==="Luftfeuchtigkeit"){return compare(d.luftfeuchtigkeit,cutoff)}else if(criteria==="Luftdruck"){return compare(d.luftdruck,cutoff)}else if(criteria==="Lufttemperatur"){return compare(d.lufttemperatur,cutoff)}else if(criteria==="Niederschlag"){return compare(d.niederschlag,cutoff)}else if(criteria==="Globalstrahlung"){return compare(d.schnee,cutoff)}}function compare(diff,cutoff){if(diff>cutoff){return 1}else{return 0}}function GroupBubbles(){hideTitles();simulation.force('x',d3.forceX().strength(forceStrength).x(center.x));simulation.force('y',d3.forceY().strength(forceStrength).y(center.y));simulation.alpha(1).restart()}function splitBubbles(args){showTitles(args);simulation.force('x',d3.forceX().strength(forceStrength).x(d=>{return nodeXPos(d,args)}));simulation.force('y',d3.forceY().strength(forceStrength).y(d=>{return nodeYPos(d,args)}));simulation.alpha(1).restart()}function hideTitles(){svg.selectAll('.title').remove()}function showTitles(args){svg.selectAll('.title').remove();let years=svg.selectAll('text.title').data([{x:0,y:1,title:args.category2,cutoff:args.cutoff2,lower:true},{x:0,y:2,title:args.category2,cutoff:args.cutoff2,lower:false},{x:1,y:0,title:args.category1,cutoff:args.cutoff1,lower:true},{x:2,y:0,title:args.category1,cutoff:args.cutoff1,lower:false}]);years.enter().append('text').attr('class','title').attr('text-anchor',d=>{return(d.x===0?'left':'middle')}).attr('transform',d=>{return 'translate('+titleX[d.x]+','+titleY[d.y]+') rotate('+(d.x===0?'-90':'0')+')'}).text(function(d){return getInfoFiller(d.title,d.lower)+' '+d.title+' als '+d.cutoff+getUnit(d.title,true)})}function showDetail(d){document.getElementById("line").innerHTML=d.LINIEN_TEXT;document.getElementById("lineNumber").innerHTML=d.LINIEN_ID;document.getElementById("arrival").innerHTML=d.ANKUNFTSZEIT.getHours().toString().padStart(2,'0')+':'+d.ANKUNFTSZEIT.getMinutes().toString().padStart(2,'0');document.getElementById("dayOfService").innerHTML=d.ANKUNFTSZEIT.getDate()+"-"+(d.ANKUNFTSZEIT.getMonth()+1)+"-"+d.ANKUNFTSZEIT.getFullYear();document.getElementById("delay").innerHTML=d.AN_PROGNOSE.getHours().toString().padStart(2,'0')+':'+d.AN_PROGNOSE.getMinutes().toString().padStart(2,'0')+"<br>("+(d.diff>= -delayCutoff?"Keine Verspätung":dateDiffToString(Math.abs(d.diff)))+")";document.getElementById("sunshine").innerHTML=d.sonnenschein;document.getElementById("rainfall").innerHTML=d.niederschlag;document.getElementById("snow").innerHTML=d.schnee;document.getElementById("temperature").innerHTML=d.lufttemperatur;document.getElementById("humidity").innerHTML=d.luftfeuchtigkeit;document.getElementById("air_pressure").innerHTML=d.luftdruck;updateCarousel(d.block)}function getColor(d,colorRollingStock){if(colorRollingStock){return fillColorRollingStock(getTrainType(d.block))}else{return fillColorLine(d.LINIEN_TEXT)}}chart.toggleDisplay=function(doSplit,args){if(doSplit){splitBubbles(args)}else{GroupBubbles(args)}};chart.changeColor=function(colorRollingStock){bubbles.attr('fill',d=>{return getColor(d,colorRollingStock)}).attr('stroke',d=>{return d3.rgb(getColor(d,colorRollingStock)).darker()})};chart.changeDelayCutoff=function(newDelayCutoff){delayCutoff=newDelayCutoff;bubbles.attr('r',d=>{return calcRadius(d)})};return chart}let myBubbleChart=bubbleChart();function display(error,data,args){if(error){console.log(error)}myBubbleChart('#canvas',data,args);if(args.category1!==undefined){myBubbleChart.toggleDisplay(true,args)}}function changeChart(doSplit,args){if(doSplit){myBubbleChart.toggleDisplay(doSplit,args)}else{loadChart(args)}}function changeColors(colorRollingStock){myBubbleChart.changeColor(colorRollingStock)}function changeDelayCutoff(newDelayCutoff){delayCutoff=newDelayCutoff}function loadChart(args){$("#canvas").empty();d3.json('data/sbb_data_merged_v1.min.json',(e,d)=>{display(e,d,args)})}loadChart({dates:{date1:new Date(2021,0,1),date2:new Date(2021,0,2),date3:new Date(2021,3,29),date4:new Date(2021,3,30)}});changedInputDates();function getUnit(criteria,forSVG){let unit=null;if(criteria==="Sonnenschein"){unit="min"}else if(criteria==="Schnee"){unit="cm"}else if(criteria==="Luftfeuchtigkeit"){unit="%"}else if(criteria==="Luftdruck"){unit="hPa"}else if(criteria==="Lufttemperatur"){unit="°C"}else if(criteria==="Niederschlag"){unit="mm"}else if(criteria==="Globalstrahlung"){unit=forSVG?"W/m2":"W/m<sup>2</sup>"}console.assert(unit!=null);return unit}function getInfoFiller(criteria,lower){if(criteria==='Luftfeuchtigkeit'||criteria==='Lufttemperatur'){return lower?'Tiefere':'Höhere'}else if(criteria==='Luftdruck'){return lower?'Tieferer':'Höherer'}else{return lower?'Weniger':'Mehr'}}function dateDiffToString(diff){let min=Math.floor(diff/60000);let sec=Math.floor((diff-min*60000)/1000);return min+' Min '+sec+' Secs'}function getTrainType(block){block=block.toLowerCase();if(block.includes("2e")){return "IC2000"}else if(block.includes("rabde502")){return "FVDosto"}else if(block.includes("icn")){return "ICN"}else{return "Eurocity"}}function updateCarousel(block){let trainType=getTrainType(block);document.getElementById("imageCarousel1").src="Graphics/Images/Trains/"+trainType+"/1.webp";document.getElementById("imageCarousel2").src="Graphics/Images/Trains/"+trainType+"/2.webp";document.getElementById("imageCarousel3").src="Graphics/Images/Trains/"+trainType+"/3.webp";document.getElementById("imageCarousel4").src="Graphics/Images/Trains/"+trainType+"/4.webp"}
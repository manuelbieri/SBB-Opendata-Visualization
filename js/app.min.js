let delayCutoff=3;function bubbleChart(){let e=940,t=600,n={x:e/2,y:t/2},r={0:{x:e/3},1:{x:2*e/3}},a={0:{y:t/3},1:{y:t/3*2}};const o=new Set;let l={0:30,1:r[0].x,2:r[1].x},i={0:20,1:a[0].y-30,2:a[1].y+30},u=.03,c=null,f=null,d=[];let s=d3.forceSimulation().velocityDecay(.2).force("x",d3.forceX().strength(u).x(n.x)).force("y",d3.forceY().strength(u).y(n.y)).force("charge",d3.forceManyBodyReuse().strength(function(e){return-Math.pow(e.radius,2.45)*u})).on("tick",function(){f.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})});s.stop();let g=d3.scaleOrdinal().domain(["IC6","IC61","IC1","IC8"]).range(["red","orange","blue","green"]),h=d3.scaleOrdinal().domain(["IC2000","FVDosto","ICN","Eurocity"]).range(["red","orange","blue","green"]);function m(e){return e>60*-delayCutoff*1e3?3:Math.log10(Math.abs(e))}let T=function(n,r,a){d=function(n,r){for(let e=0;e<n.length;e++)n[e].ANKUNFTSZEIT=new Date(n[e].ANKUNFTSZEIT),n[e].AN_PROGNOSE=new Date(n[e].AN_PROGNOSE),n[e].BETRIEBSTAG=new Date(n[e].BETRIEBSTAG),o.add(n[e].BETRIEBSTAG.getDate()+"-"+(n[e].BETRIEBSTAG.getMonth()+1)+"-"+n[e].BETRIEBSTAG.getFullYear());n=n.filter(e=>{let t=r.date1.getTime()<=e.ANKUNFTSZEIT.getTime()&&e.ANKUNFTSZEIT.getTime()<=r.date2.getTime();return null!=r.date3&&null!=r.date4?t||r.date3.getTime()<=e.ANKUNFTSZEIT.getTime()&&e.ANKUNFTSZEIT.getTime()<=r.date4.getTime():t});let a=Array.from(o);setUpDateRange("#firstDateRange",a,0,1),setUpDateRange("#secondDateRange",a,a.length-2,a.length-1),parseSliderDates();let l=n.map(function(n){let r=(a=n).ANKUNFTSZEIT-a.AN_PROGNOSE;var a;return{ANKUNFTSZEIT:n.ANKUNFTSZEIT,AN_PROGNOSE:n.AN_PROGNOSE,LINIEN_ID:n.LINIEN_ID,diff:r,radius:m(r),LINIEN_TEXT:n.LINIEN_TEXT,block:n.block,BETRIEBSTAG:n.BETRIEBSTAG,globalstrahlung:n.globalstrahlung,luftdruck:n.luftdruck,luftfeuchtigkeit:n.luftfeuchtigkeit,lufttemperatur:n.lufttemperatur,niederschlag:n.niederschlag,schnee:n.schnee,sonnenschein:n.sonnenschein,x:e/2+(40*Math.random()-20),y:t/2+(40*Math.random()-20)}});return l.sort(function(e,t){return t.diff-e.diff}),l}(r,a.dates),c=d3.select(n).append("svg").attr("width",e).attr("height",t);let l=(f=c.selectAll(".bubble").data(d,function(e){return e.LINIEN_ID})).enter().append("circle").classed("bubble",!0).attr("r",0).attr("fill",e=>p(e,isRollingStockColor())).attr("stroke",e=>d3.rgb(p(e,isRollingStockColor())).darker()).attr("stroke-width",2).on("click",S).on("mouseover",(e,t,n)=>{d3.select(n[t]).attr("stroke","black")}).on("mouseout",(e,t,n)=>{d3.select(n[t]).attr("stroke",e=>d3.rgb(p(e,isRollingStockColor())).darker())});(f=f.merge(l)).transition().duration(2e3).attr("r",function(e){return e.radius}),s.nodes(d),E()};function y(e,t,n){return"Sonnenschein"===e?I(n.sonnenschein,t):"Schnee"===e?I(n.schnee,t):"Luftfeuchtigkeit"===e?I(n.luftfeuchtigkeit,t):"Luftdruck"===e?I(n.luftdruck,t):"Lufttemperatur"===e?I(n.lufttemperatur,t):"Niederschlag"===e?I(n.niederschlag,t):"Globalstrahlung"===e?I(n.schnee,t):void 0}function I(e,t){return e>t?1:0}function E(){c.selectAll(".title").remove(),s.force("x",d3.forceX().strength(u).x(n.x)),s.force("y",d3.forceY().strength(u).y(n.y)),s.alpha(1).restart()}function N(e){!function(e){c.selectAll(".title").remove(),c.selectAll("text.title").data([{x:0,y:1,title:e.category2,cutoff:e.cutoff2,lower:!0},{x:0,y:2,title:e.category2,cutoff:e.cutoff2,lower:!1},{x:1,y:0,title:e.category1,cutoff:e.cutoff1,lower:!0},{x:2,y:0,title:e.category1,cutoff:e.cutoff1,lower:!1}]).enter().append("text").attr("class","title").attr("text-anchor",e=>0===e.x?"left":"middle").attr("transform",e=>"translate("+l[e.x]+","+i[e.y]+") rotate("+(0===e.x?"-90":"0")+")").text(function(e){return getInfoFiller(e.title,e.lower)+" "+e.title+" als "+e.cutoff+getUnit(e.title,!0)})}(e),s.force("x",d3.forceX().strength(u).x(t=>(function(e,t){return r[y(t.category1,t.cutoff1,e)].x})(t,e))),s.force("y",d3.forceY().strength(u).y(t=>(function(e,t){return a[y(t.category2,t.cutoff2,e)].y})(t,e))),s.alpha(1).restart()}function S(e){document.getElementById("line").innerHTML=e.LINIEN_TEXT,document.getElementById("lineNumber").innerHTML=e.LINIEN_ID,document.getElementById("arrival").innerHTML=e.ANKUNFTSZEIT.getHours().toString().padStart(2,"0")+":"+e.ANKUNFTSZEIT.getMinutes().toString().padStart(2,"0"),document.getElementById("dayOfService").innerHTML=e.ANKUNFTSZEIT.getDate()+"-"+(e.ANKUNFTSZEIT.getMonth()+1)+"-"+e.ANKUNFTSZEIT.getFullYear(),document.getElementById("delay").innerHTML=e.AN_PROGNOSE.getHours().toString().padStart(2,"0")+":"+e.AN_PROGNOSE.getMinutes().toString().padStart(2,"0")+"<br>("+(e.diff>=-delayCutoff?"Keine Verspätung":dateDiffToString(Math.abs(e.diff)))+")",document.getElementById("sunshine").innerHTML=e.sonnenschein+" "+getUnit("Sonnenschein",!1),document.getElementById("rainfall").innerHTML=e.niederschlag+" "+getUnit("Niederschlag",!1),document.getElementById("snow").innerHTML=e.schnee+" "+getUnit("Schnee",!1),document.getElementById("temperature").innerHTML=e.lufttemperatur+" "+getUnit("Lufttemperatur",!1),document.getElementById("humidity").innerHTML=e.luftfeuchtigkeit+" "+getUnit("Luftfeuchtigkeit",!1),document.getElementById("air_pressure").innerHTML=e.luftdruck+" "+getUnit("Luftdruck",!1),updateCarousel(e.block)}function p(e,t){return t?h(getTrainType(e.block)):g(e.LINIEN_TEXT)}return T.toggleDisplay=function(e,t){e?N(t):E()},T.changeColor=function(e){f.attr("fill",t=>p(t,e)).attr("stroke",t=>d3.rgb(p(t,e)).darker())},T.changeDelayCutoff=function(e){delayCutoff=e,f.transition().duration(1e3).attr("r",e=>m(e.diff))},T}let myBubbleChart=bubbleChart();function display(e,t,n){e&&console.log(e),myBubbleChart("#canvas",t,n),void 0!==n.category1&&myBubbleChart.toggleDisplay(!0,n)}function changeChart(e,t){e?myBubbleChart.toggleDisplay(e,t):loadChart(t)}function changeColors(e){myBubbleChart.changeColor(e)}function changeDelayCutoff(e){myBubbleChart.changeDelayCutoff(e)}function loadChart(e){$("#canvas").empty(),d3.json("data/sbb_data_merged_v1.min.json",(t,n)=>{display(t,n,e)})}function getUnit(e,t){let n=null;return"Sonnenschein"===e?n="min":"Schnee"===e?n="cm":"Luftfeuchtigkeit"===e?n="%":"Luftdruck"===e?n="hPa":"Lufttemperatur"===e?n="°C":"Niederschlag"===e?n="mm":"Globalstrahlung"===e&&(n=t?"W/m2":"W/m<sup>2</sup>"),console.assert(null!=n),n}function getInfoFiller(e,t){return"Luftfeuchtigkeit"===e||"Lufttemperatur"===e?t?"Tiefere":"Höhere":"Luftdruck"===e?t?"Tieferer":"Höherer":t?"Weniger":"Mehr"}function dateDiffToString(e){let t=Math.floor(e/6e4);return t+" Min "+Math.floor((e-6e4*t)/1e3)+" Secs"}function getTrainType(e){return(e=e.toLowerCase()).includes("2e")?"IC2000":e.includes("rabde502")?"FVDosto":e.includes("icn")?"ICN":"Eurocity"}function updateCarousel(e){let t=getTrainType(e);document.getElementById("imageCarousel1").src="Graphics/Images/Trains/"+t+"/1.webp",document.getElementById("imageCarousel2").src="Graphics/Images/Trains/"+t+"/2.webp",document.getElementById("imageCarousel3").src="Graphics/Images/Trains/"+t+"/3.webp",document.getElementById("imageCarousel4").src="Graphics/Images/Trains/"+t+"/4.webp"}loadChart({dates:{date1:new Date(2021,0,1),date2:new Date(2021,0,2),date3:new Date(2021,3,29),date4:new Date(2021,3,30)}}),changedInputDates();